<!DOCTYPE html>
<html>
    <head>
        <title>Visual Headline Aggregator</title>
        <a href="newsapi.org">Powered by Google News API </a>
        <style>body {margin: 0;padding: 0;}</style>
    </head>

    <body onresize="location.reload()" margin=0px>
        <div id="chart">
            <svg id="canvas" height="100%" width="100%">
               <!-- Bubble chart will be implemented here --> 
            </svg>
        </div>

        <!-- Implementing D3 library -->
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>

        <!-- Initializing JS function to create bubble chart -->
        <script>

            (function() {

                

                var pParent; // Variables used in resizing circles -- Prev parent
                var pChild;  // -- Previous Text
                var pChildT;  // -- Previous Texts value
                var pChildTS;  // -- Previous Texts font value
                var pChildS;  // -- Previous Circle radius value
                var child;   // -- Current circle
                var news;   // -- Current news sources for circle

                // DATA FROM GOOGLE-TRENDS-API
                // SORTED BY RISING, WORLD NEWS, LAST 30 DAYS, U.S
                // RELATED TOPICS OF QUERY "*"
                data = data.default.rankedList[1].rankedKeyword; 

                // RadiusScale: Radius of Circle based on data value
                var radiusScale = d3.scaleSqrt().domain([1,100000]).range([40,140])

                // Color && ColorBorder: colors of circles and their borders based on scheme
                var color = d3.scaleQuantize().domain([1,20000]).range(['#638CA6','#A3D39C','#17A697','#D4A1D2','#E45F56','#D93240','#F9AC3D','#758C33']); // d3.scale.category20b();
                var colorBorder = d3.scaleQuantize().domain([1,20000]).range(['#476577','#8EB787','#138C7E','#B285B1','#C6514B','#B72C3A','#E8A34E','#62752B']); // d3.scale.category20b();

                // Starting initialization of variables
                var svg = d3.select("#canvas") // Selecting HTML object SVG canvas
                var elem = svg.selectAll("g")  // Initializing g HTML with data
                    .data(data)
                var elemEnter = elem.enter()   // Appending g: container of circle and text
                    .append("g")
                    .attr("transform", function(d){
                        "translate(" + window.innerWidth/2 + 
                        "," +  
                        window.innerHeight/2+ 
                        ")";  
                    })
                    .style("white-space", "pre");
                var circles = elemEnter.append("circle") // Initializing Circles
                    .attr("r", function(d){ return radiusScale(d.value); })
                    .attr("value", function(d){ return d.value; })
                    .attr('cx', function(d) { return window.innerWidth/2; })
                    .attr('cy', function(d) { return window.innerHeight/2; })
                    .attr("fill", function(d){ return color(d.value); })
                    .attr('id', function(d) { return d.topic.title; })
                    .attr("stroke", function(d){ return colorBorder(d.value); })
                    .attr("stroke-width", function(d) { return radiusScale(d.value)/10; })
                    .on("mousedown", function(d) {      // Circle Resize functionality
                        if(this !== child){
                            if(typeof pChild  !== "undefined"){
                                shrinkCircle(d);
                            }
                            child = this;
                            pParent = this.parentNode;
                            pChild = pParent.children;
                            pChild = pChild[1].children
                            pChildT = pChild[0].innerHTML;
                            pChildTS = pChild[0].getAttribute("font-size");
                            pChildS = child.getAttribute("value");
                            var url='https://newsapi.org/v2/everything?' +
                                'q='+pChildT+'&' +
                                'from='+ new Date(new Date().setDate(new Date().getDate() - 30)) +'&' +
                                'sortBy=popularity&' +
                                'apiKey=af2c24b426a34038888bd4e88d263052';
                            var req = new Request(url);
                            fetch(req)
                                .then(response => response.json())
                                .then(function(post){
                                    news = post.articles;
                                    console.log(post.articles);
                                    growCircle(d);
                                    simulation();
                                });
                            
                        }
                        else if(typeof pChild  !== "undefined"){
                            shrinkCircle(d);
                            child = undefined;
                            pParent = undefined;
                            pChild = undefined;
                            pChildT = undefined;
                            pChildTS = undefined;
                            pChildS = undefined;
                            simulation();
                        }   
                    })
                var texts = elemEnter.append("text") // Initializing Text variables (Text in circle)
                    .append("tspan")
                    .attr("class", "circleText")
                    .attr("font-family", "Segoe UI")
                    .attr("dy",function(d){ d.value; })
                    .attr('x', function(d) { return window.innerWidth/2; })
                    .attr('y', function(d) { return (window.innerHeight/2); })
                    .attr("font-size",function(d){
                        return "" +
                        radiusScale(d.value)/(Math.sqrt(d.topic.title.length)*Math.PI/2) +
                        "px";
                    })
                    .style("text-anchor","middle")
                    .text(function(d){return d.topic.title;});
                    
                // Starting program ***
                var sim = d3.forceSimulation(data)
                        .velocityDecay(0.2)
                        .force('charge', d3.forceManyBody().strength(5))
                        .force("x", d3.forceX((window.innerWidth*1.2)/2).strength(0.010))
                        .force("y", d3.forceY(window.innerHeight/2).strength(0.02))
                        .force("collide", d3.forceCollide().radius(function(d) { return radiusScale(d.value) + 10; }))
                        .on("tick", ticked); 

            /* ~~~~~~~~~~~~~~~~~~~~  FUNCTIONS BELOW ~~~~~~~~~~~~~~~~~~~~ */


                function shrinkCircle(d){ // To shrink the Circle to original size
                    var textChild = pChild[0];
                    
                    d3.selectAll(".temp").remove();
                    d3.select(textChild).transition().duration(200)
                        .attr("font-size",function(d){ return pChildTS; })
                        .attr("visibility", "hidden")
                        .text(pChildT);
                    d3.select(child).transition().duration(200)
                        .attr("r", function(d){
                            d.value = pChildS;
                            return radiusScale(d.value);
                        })
                        .style("cursor", "pointer") 

                        setTimeout(function(){ 
                            d3.select(textChild).transition().duration(2)
                            .attr("dy", 0)
                            .attr("visibility", "visible")
                        },200);         
                }

                function growCircle(d){ // To Grow the Circle to enlarged size

                    d3.select(pChild[0]).transition().duration(600)
                        .attr("font-size",function(d){
                            return "" +
                            window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*Math.PI) +
                            "px";
                        })
                        .attr("visibility", "hidden")
        
                        d3.select(child).transition().duration(600)
                        .attr("r", function(d){
                            d.value = window.innerWidth*800;
                            return radiusScale(d.value);
                        })
                        .style("cursor", "pointer");  

                        setTimeout(function(){ 
                            d3.select(pChild[0]).transition().duration(2)
                            .attr("dy", -240)
                            .attr("visibility", "visible")
                            d3.select(pChild[0].parentNode).append('tspan')
                                    .attr("dy", 50)
                                    .attr("dx", "-" + getTextWidth(pChild[0].innerHTML, 
                                    window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*Math.PI) + 
                                    "px Segoe UI"))
                                    .attr("class","temp")
                                    .attr("font-family", "Segoe UI")
                                    .attr("font-size", window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*2*Math.PI))
                                    .text("1. " + news[0].url);
                            for(var i = 1; i < 10; i++){
                                d3.select(pChild[0].parentNode).append('tspan')
                                    .attr("dy", 40)
                                    .attr("dx", "-" + getTextWidth(pChild[i].innerHTML, 
                                    window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*2*Math.PI) + 
                                    "px Segoe UI"))
                                    .attr("class","temp")
                                    .attr("font-family", "Segoe UI")
                                    .attr("font-size", window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*2*Math.PI))
                                    .text("" + (i+1) + ". " + news[i].url);
                            }
                        },600);    
                }

                function simulation(){ // Moving the circles and grouping them in the middle
                    
                    // if(sim != undefined){ sim.stop(); sim.alpha(1).restart(); }
                    sim
                        .velocityDecay(0.2)
                        .force("x", d3.forceX((window.innerWidth)/2).strength(0.075))
                        .force("y", d3.forceY(window.innerHeight/2).strength(0.175))
                        .force("collide", d3.forceCollide().radius(function(d) { return radiusScale(d.value) + 10; }).strength(.25))
                        .alpha(.1)
                        .restart()
     
                }

                function getTextWidth(text, font) {
                    // re-use canvas object for better performance
                    var canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
                    var context = canvas.getContext("2d");
                    context.font = font;
                    var metrics = context.measureText(text);
                    return metrics.width;
                }

                // Level of attraction of circles based on data value
                function charge(d){ return Math.pow(radiusScale(d.value), 2.0) * 0.03; }

                function ticked(){ // Dynamic movement of circles to one another
                    circles
                        .attr("cx", function(d){ return d.x })
                        .attr("cy", function(d){ return d.y })
                    texts
                        .attr("x", function(d){ return d.x })
                        .attr("y", function(d){ return d.y + radiusScale(d.value)/d.y })
                }
            })();

        </script>
    </body>
</html>