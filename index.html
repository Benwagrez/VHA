<!DOCTYPE html>
<!--*  Visual Headline Aggregator  *-->
<!--*  Made by: Benjamin Wagrez,   *-->
<!--*  Ashley Jones, Kaitlyn Knabe *-->
<!--*  Ryan Grunsten               *-->
<html>
    <head>
        <title>Visual Headline Aggregator</title>
        <style>body {margin: 0;padding: 0;}</style>
    </head>

    <body onresize="location.reload()" margin=0px>
        <div id="chart">
            <svg id="canvas" height="100%" width="100%">
                <!-- Credit to Google News API as per TOS --> 
                <a xlink:href="http://www.newsapi.org">
                    <text font-family="Segoe UI" font-size="10" font-weight="normal">
                        <tspan x="5" y="20" style="color: #D3D3D3;opacity: 0.25;text-decoration: none;">
                            Powered by Google News API 
                        </tspan>
                    </text>
                </a>
               <!-- Bubble chart will be implemented here --> 
            </svg>
        </div>

        <!-- Implementing D3 library -->
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>

        <!-- Initializing JS function to create bubble chart -->
        <script>

            (function() {

/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  VARIABLES BELOW ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */


                var pParent; // Variables used in resizing circles -- Prev parent
                var pChild;  // -- Previous Text
                var pChildT;  // -- Previous Texts value
                var pChildTS;  // -- Previous Texts font value
                var pChildS;  // -- Previous Circle radius value
                var child;   // -- Current circle
                var news;   // -- Current news sources for circle

                // DATA FROM GOOGLE-TRENDS-API
                // SORTED BY RISING, WORLD NEWS, LAST 30 DAYS, U.S
                // RELATED TOPICS OF QUERY "*"
                data = data.default.rankedList[1].rankedKeyword; 

                // RadiusScale: Radius of Circle based on data value
                var radiusScale = d3.scaleSqrt().domain([1,100000]).range([40,140])

                // Color && ColorBorder: colors of circles and their borders based on scheme
                var color = d3.scaleQuantize().domain([1,20000]).range(['#638CA6','#A3D39C','#17A697','#D4A1D2','#E45F56','#D93240','#F9AC3D','#758C33']); // d3.scale.category20b();
                var colorBorder = d3.scaleQuantize().domain([1,20000]).range(['#476577','#8EB787','#138C7E','#B285B1','#C6514B','#B72C3A','#E8A34E','#62752B']); // d3.scale.category20b();

                // Starting initialization of variables
                var svg = d3.select("#canvas") // Selecting HTML object SVG canvas
                var elem = svg.selectAll("g")  // Initializing g HTML with data
                    .data(data)
                var elemEnter = elem.enter()   // Appending g: container of circle and text
                    .append("g")
                    .attr("transform", function(d){
                        "translate(" + window.innerWidth/2 + 
                        "," +  
                        window.innerHeight/2+ 
                        ")";  
                    })
                    .style("white-space", "pre");
                var circles = elemEnter.append("circle") // Initializing Circles
                    .attr("r", function(d){ return radiusScale(d.value); }) // Radius
                    .attr("value", function(d){ return d.value; }) // Value passed over for recall
                    .attr('cx', function(d) { return window.innerWidth/2; }) 
                    .attr('cy', function(d) { return window.innerHeight/2; })
                    .attr("fill", function(d){ return color(d.value); }) // Fill color
                    .attr('id', function(d) { return d.topic.title; }) // Circle ID as topic title
                    .attr("stroke", function(d){ return colorBorder(d.value); }) // Circle border
                    .attr("stroke-width", function(d) { return radiusScale(d.value)/10; }) // Circle border width
                    .on("mousedown", function(d) {      // Circle Resize functionality
                        if(this !== child){ // Checking if the user clicked on previously selected circle - If not --Below
                            if(typeof pChild  !== "undefined"){ // Check if there was previous selection
                                shrinkCircle(d); // If so shrink previous circle
                            }
                            child = this; // Assigning variables based on selected circle
                            pParent = this.parentNode; // -
                            pChild = pParent.children; // pChild defined twice to identify tspans (text not very important)
                            pChild = pChild[1].children // -
                            pChildT = pChild[0].innerHTML; // -
                            pChildTS = pChild[0].getAttribute("font-size"); // -
                            pChildS = child.getAttribute("value"); // -
                            var url='https://newsapi.org/v2/everything?' + // GOOGLE NEWS API DATA PULL HERE
                                'q='+pChildT+'&' +
                                'from='+ new Date(new Date().setDate(new Date().getDate() - 30)) +'&' +
                                'sortBy=popularity&' +
                                'apiKey=af2c24b426a34038888bd4e88d263052';
                            var req = new Request(url);
                            fetch(req)
                                .then(response => response.json())
                                .then(function(post){ // WAIT FOR DATA: ERROR HERE IF MAX LIMIT REACHED
                                    news = post.articles;
                                    console.log(post.articles);
                                    growCircle(d);
                                    simulation(); // Simulate to restore circle positions
                                });  
                        }
                        else if(typeof pChild  !== "undefined"){ // if user did click on previous circle --Below
                            shrinkCircle(d); // Shrink Circle
                            child = undefined; // Dumping variables
                            pParent = undefined;
                            pChild = undefined;
                            pChildT = undefined;
                            pChildTS = undefined;
                            pChildS = undefined;
                            simulation(); // Simulate to restore circle positions
                        }   
                    })
                var texts = elemEnter.append("text") // Initializing Text variables (Text in circle)
                    .append("tspan")
                    .attr("class", "circleText")
                    .attr("font-family", "Segoe UI")
                    .attr("dx",function(d){ return "-" + (getTextWidth(d.topic.title, // Disparity in X value, to align texts
                    radiusScale(d.value)/(Math.sqrt(d.topic.title.length)*Math.PI/2) + 
                    "px Segoe UI"))/2; })
                    .attr('x', function(d) { return window.innerWidth/2; })
                    .attr('y', function(d) { return (window.innerHeight/2); })
                    .attr("font-size",function(d){ // Font-size based on title length and size of circle
                        return "" +
                        radiusScale(d.value)/(Math.sqrt(d.topic.title.length)*Math.PI/2) +
                        "px";
                    })
                    .text(function(d){return d.topic.title;}); // Title text within circle
                    
                // Starting program *** 
                var sim = d3.forceSimulation(data)
                    .velocityDecay(0.2)
                    .force('charge', d3.forceManyBody().strength(5))
                    .force("x", d3.forceX((window.innerWidth*1.1)/2).strength(0.010))
                    .force("y", d3.forceY(window.innerHeight/2).strength(0.02))
                    .force("collide", d3.forceCollide().radius(function(d) { return radiusScale(d.value) + 10; }))
                    .on("tick", ticked); 

/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  FUNCTIONS BELOW ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
/* ~~~~~~~~~~~~~~~~~~~~~~~~  Function  ~~~~~~~~~~~~~~~||~~~~~~~~~~~~~~~  Purpose  ~~~~~~~~~~~~~~~~~~~~~~~~*/
/* ~~~~~~~~~~~~~~~~~~  shrinkCircle                   ||  Taking user input (mousedown) in order to       */
/* ~~~~~~~~~~~~~~~~~~                                 ||  shrink current enlarged circle                  */
/* ~~~~~~~~~~~~~~~~~~  growCircle                     ||  Taking user input (mousedown) in order to       */
/* ~~~~~~~~~~~~~~~~~~                                 ||  grow circle that was selected                   */
/* ~~~~~~~~~~~~~~~~~~  simulation                     ||  function designed to reset D3 simulation in     */
/* ~~~~~~~~~~~~~~~~~~                                 ||  order to dynamically resort circles             */
/* ~~~~~~~~~~~~~~~~~~  getTextWidth                   ||  Returns width text element take up for styling  */
/* ~~~~~~~~~~~~~~~~~~                                 ||  purposes                                        */
/* ~~~~~~~~~~~~~~~~~~  Ticked                         ||  Dynamically moves the circles under simulation  */
/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/


                function shrinkCircle(d){ // To shrink the Circle to original size
                    var textChild = pChild[0];
                    
                    d3.selectAll(".temp").remove();
                    d3.select(textChild).transition().duration(200)
                        .attr("font-size",function(d){ return pChildTS; })
                        .attr("visibility", "hidden")
                        .text(pChildT);
                    d3.select(child).transition().duration(200)
                        .attr("r", function(d){
                            d.value = pChildS;
                            return radiusScale(d.value);
                        })
                        setTimeout(function(){ 
                            d3.select(textChild).transition().duration(2)
                            .attr("dy", 0)
                            .attr("dx",function(d){ return "-" + (getTextWidth(d.topic.title, 
                            radiusScale(d.value)/(Math.sqrt(d.topic.title.length)*Math.PI/2) + 
                            "px Segoe UI"))/2; })
                            .attr("visibility", "visible")
                        },200);         
                }

                function growCircle(d){ // To Grow the Circle to enlarged size

                    var prevD = "";
                    var prevF = 0;
                    var iDx = window.innerWidth/7;
                    console.log(iDx);
                    d3.select(pChild[0]).transition().duration(600)
                        .attr("font-size",function(d){
                            return "" +
                            window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*Math.PI) +
                            "px";
                        })
                        .attr("visibility", "hidden")
        
                        d3.select(child).transition().duration(600)
                        .attr("r", function(d){
                            d.value = window.innerWidth*500;
                            return radiusScale(d.value);
                        })

                        setTimeout(function(){ // Setting timeout in order to allow transitions to take place
                            d3.select(pChild[0]).transition().duration(2)
                            .attr("dy", -200)
                            .attr("dx", function(d){ return "-" + (getTextWidth(d.topic.title, 
                            window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*Math.PI) + 
                            "px Segoe UI"))/2; })
                            .attr("visibility", "visible")
                            prevD = pChild[0].innerHTML.substring(0, pChild[0].innerHTML.length/2);
                            prevF = window.innerWidth/(Math.sqrt(d.topic.title.length)*Math.PI*Math.PI);
                            for(var i = 0; i < 10; i++){
                                pChild = pParent.children;
                                pChild = pChild[1].children;
                                var temp = d3.select(pChild[0].parentNode).append('tspan')
                                    .attr("dy", 20)
                                    .attr("dx", "-" + (iDx +
                                    getTextWidth(prevD, 
                                    prevF + 
                                    "px Segoe UI")))
                                    .attr("class","temp")
                                    .attr("font-family", "Segoe UI")
                                    .attr("font-size", window.innerWidth/(100))
                                    .append("a")
                                    .attr("xlink:href", news[i].url)
                                    .attr("target", "_blank")
                                    .text(function(d){if(news[i].url.length>60){ return "" + (i+1) + ". " + news[i].url.substring(0,57) + "...";}
                                                      else {return "" + (i+1) + ". " + news[i].url;}})
                                    .append("tspan")
                                    .attr("dy", 13)
                                    .attr("dx", function(d){if(news[i].url.length>60){ return "-" + getTextWidth("1. " +
                                    news[i].url.substring(0,57) + "...", 
                                    window.innerWidth/(100) + 
                                    "px Segoe UI");}
                                    else{return "-" + getTextWidth("1. "+news[i].url, 
                                    window.innerWidth/(100) + 
                                    "px Segoe UI");}})
                                    .attr("font-family", "Segoe UI")
                                    .attr("font-size", window.innerWidth/(100))
                                    .text(function(d){if(news[i].title.length>60){ prevD = "" + news[i].title.substring(0,57) + "...";return "" + news[i].title.substring(0,57) + "...";}
                                                      else {prevD = "" + news[i].title;return "" + news[i].title;}});
                                    prevF = window.innerWidth/(100);
                                    iDx = 0;
                            }
                        },600);    
                }

                function simulation(){ // Moving the circles and grouping them in the middle
                    
                    sim
                        .velocityDecay(0.2)
                        .force("x", d3.forceX((window.innerWidth)/2).strength(0.075))
                        .force("y", d3.forceY(window.innerHeight/2).strength(0.175))
                        .force("collide", d3.forceCollide().radius(function(d) { return radiusScale(d.value) + 10; }).strength(.4))
                        .alpha(.2)
                        .restart()
                }

                function getTextWidth(text, font) { // Relaying the width a text of 'font' font takes on the screen
                    // re-use canvas object for better performance
                    var canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
                    var context = canvas.getContext("2d");
                    context.font = font;
                    var metrics = context.measureText(text);
                    return metrics.width;
                }

                function ticked(){ // Dynamic movement of circles to one another
                    circles
                        .attr("cx", function(d) { return d.x = Math.max(radiusScale(d.value), Math.min(window.innerWidth - radiusScale(d.value), d.x)); })
                        .attr("cy", function(d) { return d.y = Math.max(radiusScale(d.value), Math.min(window.innerHeight - radiusScale(d.value), d.y)); })
                    texts
                        .attr("x", function(d){ return d.x })
                        .attr("y", function(d){ return d.y + radiusScale(d.value)/d.y })
                }
/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~END OF FUNCTIONS~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
            })();
        </script>
    </body>
</html>